name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Status Badge: ![Deploy](https://github.com/<org>/<repo>/actions/workflows/deploy.yml/badge.svg)

# Prevents overlapping deploys to the same environment
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  kb:
    name: Validate Agent Knowledge
    runs-on: ubuntu-latest
    timeout-minutes: 5 # Fail fast if script hangs
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Validate /docs/agent
        run: node scripts/validate_agent_knowledge.mjs

  deploy:
    name: Deploy App
    runs-on: ubuntu-latest
    needs: [kb]   # <--- The Gate: Deploy waits for KB validation
    timeout-minutes: 20 # Prevent hung deploys from consuming minutes
    permissions:
      contents: read
      id-token: write
    env:
      NEXT_PUBLIC_BUILD_SHA: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      # Simulated Auth
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Mock Auth
        run: echo "Simulating Google Auth..."

      # Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Configure Docker to use gcloud as a credential helper
      - name: Configure Docker
        run: gcloud auth configure-docker us-east4-docker.pkg.dev --quiet

      # Build and push Docker image
      - name: Build and Push Docker Image
        env:
          PROJECT_ID: propflow-ai-483621
          REGION: us-east4
          SERVICE_NAME: propflow-app
          IMAGE_TAG: us-east4-docker.pkg.dev/propflow-ai-483621/propflow-repo/propflow-app:${{ github.sha }}
        run: |
          docker buildx build --platform linux/amd64 \
            --build-arg NEXT_PUBLIC_BUILD_SHA=${{ github.sha }} \
            --build-arg NEXT_PUBLIC_GCP_PROJECT_ID=propflow-ai-483621 \
            --build-arg GCP_REGION=us-east4 \
            --build-arg NEXT_PUBLIC_GCP_REGION=us-east4 \
            --build-arg NEXT_PUBLIC_APP_URL=https://propflow-ai-483621.web.app \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyD-MpLQYzlBruNZYcZUiEBIxZRWFMJ6MoU \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=propflow-ai-483621.firebaseapp.com \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID=propflow-ai-483621 \
            --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=propflow-ai-483621.firebasestorage.app \
            --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=638502512734 \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID=1:638502512734:web:d5a6d20ddbec647f91eccf \
            -t $IMAGE_TAG \
            --push \
            .

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        env:
          PROJECT_ID: propflow-ai-483621
          REGION: us-east4
          SERVICE_NAME: propflow-app
          IMAGE_TAG: us-east4-docker.pkg.dev/propflow-ai-483621/propflow-repo/propflow-app:${{ github.sha }}
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE_TAG \
            --platform managed \
            --region $REGION \
            --project $PROJECT_ID \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --timeout 300 \
            --set-env-vars NEXT_PUBLIC_BUILD_SHA=${{ github.sha }},NEXT_PUBLIC_GCP_PROJECT_ID=propflow-ai-483621,GCP_PROJECT_ID=propflow-ai-483621,GOOGLE_CLOUD_PROJECT=propflow-ai-483621,GCP_REGION=us-east4,NEXT_PUBLIC_GCP_REGION=us-east4,NEXT_PUBLIC_APP_URL=https://propflow-ai-483621.web.app,NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyD-MpLQYzlBruNZYcZUiEBIxZRWFMJ6MoU,NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=propflow-ai-483621.firebaseapp.com,NEXT_PUBLIC_FIREBASE_PROJECT_ID=propflow-ai-483621,NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=propflow-ai-483621.firebasestorage.app,NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=638502512734,NEXT_PUBLIC_FIREBASE_APP_ID=1:638502512734:web:d5a6d20ddbec647f91eccf,TRUST_HOST=true

      - name: Debug build stamp env
        run: echo "NEXT_PUBLIC_BUILD_SHA=$NEXT_PUBLIC_BUILD_SHA"

      # Firebase Hosting Deploy
      - run: npx firebase-tools deploy --only hosting --project propflow-ai-483621 --force

      # Optional Post-Deploy Smoke Check
      - name: Smoke check BUILD stamp
        timeout-minutes: 2
        continue-on-error: true
        run: |
          URL="https://propflow-ai-483621.web.app"
          echo "Hitting $URL ..."
          html=$(curl -sS -H 'Cache-Control: no-cache' "$URL")
          if echo "$html" | grep -qE 'BUILD[: ]+[0-9a-f]{7,40}'; then
            echo "✅ BUILD stamp found in HTML"
          else
            echo "⚠️  BUILD stamp not found in raw HTML (may be client-side rendered)"
          fi
