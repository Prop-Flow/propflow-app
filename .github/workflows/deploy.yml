name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

# Status Badge: ![Deploy](https://github.com/<org>/<repo>/actions/workflows/deploy.yml/badge.svg)

# Prevents overlapping deploys to the same environment
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  kb:
    name: Validate Agent Knowledge
    runs-on: ubuntu-latest
    timeout-minutes: 5 # Fail fast if script hangs
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Validate /docs/agent
        run: node scripts/validate_agent_knowledge.mjs

  deploy:
    name: Deploy App
    runs-on: ubuntu-latest
    needs: [kb] # <--- The Gate: Deploy waits for KB validation
    timeout-minutes: 60 # Prevent hung deploys from consuming minutes
    permissions:
      contents: read
      id-token: write
    env:
      NEXT_PUBLIC_BUILD_SHA: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      # Simulated Auth
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Mock Auth
        run: echo "Simulating Google Auth..."

      - name: Debug build stamp env
        run: echo "NEXT_PUBLIC_BUILD_SHA=$NEXT_PUBLIC_BUILD_SHA"

      # Firebase Hosting Deploy
      - run: npx firebase-tools deploy --only hosting --project propflow-ai-483621 --force

      - name: Submit Cloud Build
        id: build
        env:
          PROJECT_ID: propflow-ai-483621
          REGION: us-east4
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          echo "üöÄ Submitting build to Cloud Build (Async)..."

          # Get short SHA for tagging
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "Commit SHA: $SHORT_SHA"

          # Submit build asynchronously to avoid log streaming timeouts
          # Pass secrets via environment variables
          BUILD_ID=$(gcloud builds submit \
            --async \
            --config=cloudbuild.yaml \
            --project=$PROJECT_ID \
            --region=$REGION \
            --substitutions=SHORT_SHA=$SHORT_SHA,_REGION=$REGION,_PROJECT_ID=$PROJECT_ID,_APP_URL=https://$PROJECT_ID.web.app,_FIREBASE_API_KEY=$FIREBASE_API_KEY,_FIREBASE_AUTH_DOMAIN=$FIREBASE_AUTH_DOMAIN,_FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID,_FIREBASE_STORAGE_BUCKET=$FIREBASE_STORAGE_BUCKET,_FIREBASE_MESSAGING_SENDER_ID=$FIREBASE_MESSAGING_SENDER_ID,_FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --format='value(id)')

          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå Build submission failed: BUILD_ID not returned"
            exit 1
          fi

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "üìã Build ID: $BUILD_ID"
          echo "üîó Logs: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=$PROJECT_ID"

          # Poll for completion
          echo "‚è≥ Waiting for build to complete..."
          START_TIME=$(date +%s)
          TIMEOUT=5400 # 1.5 hours timeout

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED_TIME -gt $TIMEOUT ]; then
              echo "‚ùå Build polling timed out after 1 hour"
              exit 1
            fi

            STATUS=$(gcloud builds describe $BUILD_ID --project=$PROJECT_ID --region=$REGION --format='value(status)')
            
            if [[ "$STATUS" == "SUCCESS" ]]; then
              echo "‚úÖ Build Succeeded"
              break
            elif [[ "$STATUS" == "FAILURE" || "$STATUS" == "INTERNAL_ERROR" || "$STATUS" == "TIMEOUT" || "$STATUS" == "CANCELLED" ]]; then
              echo "‚ùå Build Failed with status: $STATUS"
              echo "üîó Logs: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=$PROJECT_ID"
              gcloud builds log --limit=100 $BUILD_ID || true
              exit 1
            else
              echo "Status: $STATUS (Elapsed: ${ELAPSED_TIME}s)..."
              sleep 15
            fi
          done

      - name: Get Service URL
        id: service
        if: success()
        continue-on-error: true # Don't fail workflow if just this step fails (e.g. permission issues)
        env:
          PROJECT_ID: propflow-ai-483621
          REGION: us-east4
          SERVICE_NAME: propflow-app
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region=$REGION \
            --project=$PROJECT_ID \
            --format='value(status.url)')

          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "üåê Service URL: $SERVICE_URL"

      - name: Deployment Summary
        if: always()
        env:
          PROJECT_ID: propflow-ai-483621
          REGION: us-east4
          SERVICE_NAME: propflow-app
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: $PROJECT_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: $REGION" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Status**: ‚úÖ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: ${{ steps.service.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  Deployment failed"
          fi
