name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggers

env:
  PROJECT_ID: propflow-ai-483621
  REGION: us-east4
  SERVICE_NAME: ssrpropflowai483621

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Firebase CLI
        run: |
          npm install -g firebase-tools
          firebase --version

      - name: Deploy Firestore Rules
        run: |
          echo "ðŸ“‹ Deploying Firestore security rules..."
          firebase deploy --only firestore:rules --project=$PROJECT_ID --non-interactive
          echo "âœ… Firestore rules deployed"

      - name: Validate Configuration
        run: |
          echo "ðŸ” Validating deployment configuration..."

          # Check if Artifact Registry exists
          if ! gcloud artifacts repositories describe propflow-repo \
            --location=$REGION \
            --project=$PROJECT_ID &>/dev/null; then
            echo "âš ï¸  Warning: Artifact Registry 'propflow-repo' not found. It will be created during build."
          fi

          echo "âœ… Configuration validation passed"

      - name: Submit Cloud Build
        id: build
        run: |
          echo "ðŸš€ Submitting build to Cloud Build..."

          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --project=$PROJECT_ID \
            --region=$REGION \
            --substitutions=_REGION=$REGION,_PROJECT_ID=$PROJECT_ID,_APP_URL=https://$PROJECT_ID.web.app,_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }},_FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }},_FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }},_FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }},_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }},_FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --format='value(id)')

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Build ID: $BUILD_ID"

      - name: Get Service URL
        id: service
        if: success()
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region=$REGION \
            --project=$PROJECT_ID \
            --format='value(status.url)')

          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Service URL: $SERVICE_URL"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: $PROJECT_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: $REGION" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: $SERVICE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ steps.build.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Status**: âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: ${{ steps.service.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Logs**: https://console.cloud.google.com/cloud-build/builds/${{ steps.build.outputs.build_id }}?project=$PROJECT_ID" >> $GITHUB_STEP_SUMMARY
          fi
