name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: propflow-ai-483621
  SERVICE_NAME: ssrpropflowai483621

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load & Validate Configuration
        id: config
        run: |
          echo "üîç Loading deployment configuration..."
          
          # Read from JSON
          PROJECT_ID=$(jq -r '.projectId' deployment-config.json)
          REGION=$(jq -r '.region' deployment-config.json)
          SERVICE_NAME=$(jq -r '.serviceName' deployment-config.json)
          IMAGE_NAME=$(jq -r '.imageName' deployment-config.json)
          GAR_LOCATION=$(jq -r '.artifactRegistry.location' deployment-config.json)
          REPOSITORY=$(jq -r '.artifactRegistry.repository' deployment-config.json)

          echo "‚úÖ Configuration Loaded:"
          echo "   Project: $PROJECT_ID"
          echo "   Region: $REGION"
          echo "   Service: $SERVICE_NAME"
          echo "   Image: $IMAGE_NAME"
          echo "   GAR: $GAR_LOCATION"
          echo "   Repository: $REPOSITORY"

          # Export to GITHUB_ENV for subsequent steps
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "REGION=$REGION" >> $GITHUB_ENV
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "GAR_LOCATION=$GAR_LOCATION" >> $GITHUB_ENV
          echo "REPOSITORY=$REPOSITORY" >> $GITHUB_ENV

      - name: Google Auth
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set up Cloud SDK
        uses: "google-github-actions/setup-gcloud@v2"

      - name: Authorize Docker push
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build and Push Container
        run: |
          TAG="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "üê≥ Building container: $TAG"
          docker build -t $TAG .
          docker push $TAG

      - name: Deploy to Cloud Run
        id: deploy
        uses: "google-github-actions/deploy-cloudrun@v2"
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          # Verify flags from config if possible, but hardcoding based on previous file is safer for now
          flags: "--allow-unauthenticated --memory 512Mi"
          env_vars: |
            NODE_ENV=production

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting
        # Deploy hosting config (rewrites) to point to the new Cloud Run revision
        run: firebase deploy --only hosting --project ${{ env.PROJECT_ID }} --token "${{ secrets.FIREBASE_TOKEN }}"
