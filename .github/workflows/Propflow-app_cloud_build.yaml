name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Status Badge: ![Deploy](https://github.com/<org>/<repo>/actions/workflows/deploy.yml/badge.svg)

# Prevents overlapping deploys to the same environment
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  kb:
    name: Validate Agent Knowledge
    runs-on: ubuntu-latest
    timeout-minutes: 5 # Fail fast if script hangs
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Validate /docs/agent
        run: node scripts/validate_agent_knowledge.mjs

  deploy:
    name: Deploy App
    runs-on: ubuntu-latest
    needs: [kb]   # <--- The Gate: Deploy waits for KB validation
    timeout-minutes: 20 # Prevent hung deploys from consuming minutes
    permissions:
      contents: read
      id-token: write
    env:
      NEXT_PUBLIC_BUILD_SHA: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      # Simulated Auth
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Mock Auth
        run: echo "Simulating Google Auth..."

      # Simulated Cloud Run
      - run: gcloud run deploy propflow-app --region=us-east4 --source . --quiet
      - name: Debug build stamp env
        run: echo "NEXT_PUBLIC_BUILD_SHA=$NEXT_PUBLIC_BUILD_SHA"

      - name: Mock Cloud Run Deploy
        run: echo "Simulating Cloud Run Deploy..."

      # Simulated Firebase Hosting
      - run: npx firebase-tools deploy --only hosting --project propflow-ai-483621 --force
      - name: Mock Firebase Hosting Deploy
        run: echo "Simulating Firebase Hosting Deploy..."

      # Optional Post-Deploy Smoke Check
      - name: Smoke check BUILD stamp
        timeout-minutes: 2
        run: |
          URL="https://propflow-ai-483621.web.app"
          echo "Hitting $URL ..."
          html=$(curl -sS -H 'Cache-Control: no-cache' "$URL")
          echo "$html" | grep -E 'BUILD[: ]+[0-9a-f]{7,40}' || (echo "BUILD stamp not found" && exit 1)
          # echo "Simulating Smoke Check... (Uncomment above lines in real repo)"
