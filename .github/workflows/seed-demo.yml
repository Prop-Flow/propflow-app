name: Seed Demo (Production)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - seed
          - clear
        default: 'seed'

jobs:
  seed-demo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup credentials
        run: |
          set +x
          cat > firebase-service-account-key.json <<'JSON'
          ${{ secrets.GCP_SA_KEY }}
          JSON
          chmod 400 firebase-service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/firebase-service-account-key.json" >> $GITHUB_ENV

      - name: Seed demo data
        if: ${{ github.event.inputs.action == 'seed' }}
        run: npm run seed:demo
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Clear demo data
        if: ${{ github.event.inputs.action == 'clear' }}
        run: npm run seed:demo:clear
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Verify Firestore state
        if: ${{ github.event.inputs.action == 'seed' && success() }}
        run: |
          node - <<'NODE'
          const admin = require('firebase-admin');
          const projectId = 'propflow-ai-483621';
          const fs = require('fs');
          const keyPath = process.env.GOOGLE_APPLICATION_CREDENTIALS;
          
          if (!fs.existsSync(keyPath)) {
            console.error('Credentials file not found at:', keyPath);
            process.exit(1);
          }

          admin.initializeApp({
            credential: admin.credential.cert(keyPath),
            projectId
          });

          const db = admin.firestore();

          (async () => {
            try {
              const userRecord = await admin.auth().getUserByEmail('demo@propflow.com');
              const userId = userRecord.uid;
              console.log('Verifying data for user:', userId);

              async function count(col) {
                const q = db.collection(col)
                  .where('userId', '==', userId)
                  .where('isDemo', '==', true);
                const snap = await q.get();
                return snap.size;
              }

              const props = await count('properties');
              const tenants = await count('tenants');
              const leases = await count('leases');

              const result = { projectId, userId, properties: props, tenants, leases };
              console.log(JSON.stringify(result, null, 2));

              if (props < 1 || tenants < 5 || leases < 5) {
                console.error('Validation failed: Insufficient data seeded');
                process.exit(1);
              }
              console.log('Seeding verification successful!');
            } catch (error) {
              console.error('Verification error:', error);
              process.exit(1);
            }
          })();
          NODE
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Cleanup credentials
        if: always()
        run: rm -f firebase-service-account-key.json
