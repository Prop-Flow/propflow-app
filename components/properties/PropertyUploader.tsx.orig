import { useState, useCallback, useRef, useEffect } from 'react';
import { Upload, FileText, Check, AlertCircle, X, Loader2, Plus, Trash2, Users, Building, ArrowRight } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Card } from '@/components/ui/Card';
import { Input } from '@/components/ui/Input';
import { Label } from '@/components/ui/Label';
import { useToast } from '@/hooks/use-toast';
import { Progress } from '@/components/ui/Progress';
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/Table";
import { cn } from '@/lib/utils';
import {
    ExtractedPropertyData,
    ExtractedTenantData,
    RentRollData
} from '@/lib/ai/document-parser';
import { isDemoMode } from '@/lib/config/demo';
import { useRouter } from 'next/navigation';

// Interface matching the API expectation (see app/api/properties/route.ts)
export interface WizardData {
    property?: {
        address?: string;
        city?: string;
        state?: string;
        zipCode?: string;
        units?: number;
    };
    rentRollUnits?: {
        unitNumber?: string | number;
        tenantName?: string;
        currentRent?: number;
        marketRent?: number;
        leaseEndDate?: string | Date;
        leaseStartDate?: string | Date;
        status?: string;
        email?: string;
        phone?: string;
        deposit?: number;
    }[];
}

interface PropertyUploaderProps {
    onAnalysisComplete: (data: WizardData) => void;
    initialStep?: string;
    className?: string;
}

type UploadStep = 'upload-method' | 'upload-lease' | 'upload-rent-roll' | 'manual-entry' | 'review' | 'analysis' | 'occupancy-check';

// Local interface for form state
interface LocalPropertyData {
    address: string;
    city: string;
    state: string;
    zipCode: string;
    buildingName: string;
}

export default function PropertyUploader({ onAnalysisComplete, initialStep, className }: PropertyUploaderProps) {
    const [step, setStep] = useState<UploadStep>('occupancy-check');
    const [isDragging, setIsDragging] = useState(false);
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [parsingProgress, setParsingProgress] = useState<{ current: number; total: number; filename: string } | null>(null);
    const [analysisStep, setAnalysisStep] = useState<string>('');
    const [error, setError] = useState<string | null>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const { toast } = useToast();
    const router = useRouter();
    const demoMode = isDemoMode();

    const [propertyData, setPropertyData] = useState<LocalPropertyData>({
        address: '',
        city: '',
        state: '',
        zipCode: '',
        buildingName: ''
    });

    const [rentRollData, setRentRollData] = useState<RentRollData>({
        units: [],
        totals: {},
        confidence: {}
    });

    const [manualUnitCount, setManualUnitCount] = useState<string>('');

    useEffect(() => {
        if (initialStep === 'review-rent-roll') {
            setStep('review'); // Or whatever mapping makes sense, usually starts upload but client suggests review?
            // Actually better to start at upload-rent-roll if no data
            if (rentRollData.units.length === 0) setStep('upload-rent-roll');
        } else if (initialStep === 'upload-property-doc') {
            setStep('upload-rent-roll'); // or occupancy check
        }
    }, [initialStep, rentRollData.units.length]); // Run only on mount or if props change

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    }, []);

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
    }, []);


    const processFiles = useCallback(async (files: File[], context: 'property-doc' | 'lease') => {
        setIsAnalyzing(true);
        setError(null);

        let processedCount = 0;
        const totalFiles = files.length;

        // Demo mode: simulate upload and seed data
        if (demoMode) {
            try {
                // Simulate processing animation
                for (let i = 0; i < totalFiles; i++) {
                    setParsingProgress({
                        current: i + 1,
                        total: totalFiles,
                        filename: files[i].name
                    });
                    setAnalysisStep(`Verifying ${files[i].name}...`);
                    await new Promise(r => setTimeout(r, 800)); // Simulate processing time
                }

                setAnalysisStep('Seeding demo data...');

                // Call demo seed API
                const seedResponse = await fetch('/api/demo/seed', {
                    method: 'POST',
                });

                if (!seedResponse.ok) {
                    throw new Error('Failed to seed demo data');
                }

                const seedResult = await seedResponse.json();

                setAnalysisStep('Success! Loading your dashboard...');
                await new Promise(r => setTimeout(r, 1000));

                toast({
                    title: "Welcome to PropFlow!",
                    description: "Your demo account is ready with sample properties and data",
                });

                // Redirect to dashboard
                router.push('/dashboard/owner');
                return;
            } catch (err) {
                console.error('Demo activation error:', err);
                setError(err instanceof Error ? err.message : 'Failed to activate demo');
                setIsAnalyzing(false);
                setParsingProgress(null);
                return;
            }
        }

        // Helper to merge new tenant data into existing rent roll
        const mergeTenantData = (newTenant: ExtractedTenantData) => {
            setRentRollData(prev => {
                const existingUnits = [...(prev.units || [])];
                // Try to find if unit already exists
                const existingUnitIndex = newTenant.unitNumber
                    ? existingUnits.findIndex(u => u.unitNumber?.toLowerCase() === newTenant.unitNumber?.toLowerCase())
                    : -1;

                const unitData = {
                    unitNumber: newTenant.unitNumber || `Unit ${existingUnits.length + 1}`,
                    tenantName: newTenant.name || 'Unknown',
                    leaseStart: newTenant.leaseStartDate,
                    leaseEnd: newTenant.leaseEndDate,
                    currentRent: newTenant.rentAmount,
                    deposit: newTenant.securityDeposit,
                    status: 'Occupied' as const,
                    email: newTenant.email,
                    phone: newTenant.phone
                };

                if (existingUnitIndex >= 0) {
                    existingUnits[existingUnitIndex] = { ...existingUnits[existingUnitIndex], ...unitData };
                } else {
                    existingUnits.push(unitData);
                }
                return {
                    ...prev,
                    units: existingUnits,
                    totals: prev.totals || {},
                    confidence: prev.confidence || {}
                };
            });
        };

        const mergePropertyData = (newData: ExtractedPropertyData) => {
            setPropertyData(prev => {
                return {
                    address: prev.address || newData.property?.address || '',
                    city: prev.city || '', // Extraction might not separate city/state
                    state: prev.state || '',
                    zipCode: prev.zipCode || '',
                    buildingName: prev.buildingName || ''
                };
            });
        };

        try {
            for (const file of files) {
                setParsingProgress({
                    current: processedCount + 1,
                    total: totalFiles,
                    filename: file.name
                });
                setAnalysisStep(`Parsing ${file.name}...`);

                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', context);

                const response = await fetch('/api/properties/parse', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    await response.text(); // Consume body but ignore for now
                    // console.error(`Failed to parse ${file.name}:`, errorText);
                    toast({
                        title: "Error parsing file",
                        description: `Failed to process ${file.name}. Continuing with others...`,
                        variant: "destructive"
                    });
                    continue;
                }

                const responseJson = await response.json();
                const docType = responseJson.documentType;
                const extractedData = responseJson.extractedData;

                // Aggregation Logic
                if (extractedData && (extractedData.property || extractedData.owner)) {
                    mergePropertyData(extractedData as ExtractedPropertyData);
                } else if (extractedData && extractedData.propertyAddress) {
                    setPropertyData(prev => ({
                        ...prev,
                        address: prev.address || extractedData.propertyAddress || ''
                    }));
                }

                if (docType === 'lease' || (extractedData && extractedData.name && extractedData.rentAmount)) {
                    mergeTenantData(extractedData as ExtractedTenantData);
                } else if (docType === 'rent_roll' || (extractedData && extractedData.units)) {
                    const rrData = extractedData as RentRollData;
                    if (rrData.units) {
                        setRentRollData(prev => {
                            const newUnits = rrData.units.map(u => ({
                                ...u,
                                status: (u.tenantName && u.tenantName !== 'Vacant') ? ('Occupied' as const) : ('Vacant' as const)
                            }));

                            const existingUnits = [...prev.units];
                            newUnits.forEach(u => {
                                const idx = existingUnits.findIndex(eu => eu.unitNumber === u.unitNumber);
                                if (idx >= 0) existingUnits[idx] = { ...existingUnits[idx], ...u };
                                else existingUnits.push(u);
                            });

                            return {
                                ...prev,
                                units: existingUnits,
                                totals: prev.totals || {},
                                confidence: prev.confidence || {}
                            };
                        });
                    }
                } else {
                    // console.warn('Unknown document type or empty data:', docType, extractedData);
                }

                processedCount++;
            }

            setAnalysisStep('Finalizing...');
            await new Promise(r => setTimeout(r, 500));

            setStep('review');

        } catch (err) {
            console.error('Batch processing error:', err);
            setError(err instanceof Error ? err.message : 'An error occurred while processing files');
        } finally {
            setIsAnalyzing(false);
            setParsingProgress(null);
        }
    }, [toast]);

    const handleDrop = useCallback(async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
        setError(null);

        const files = Array.from(e.dataTransfer.files);
        if (files.length === 0) return;

        let context: 'property-doc' | 'lease' = 'lease';
        if (step === 'upload-rent-roll') context = 'property-doc';

        await processFiles(files, context);

    }, [step, processFiles]);

    const handleFileSelect = useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;

        let context: 'property-doc' | 'lease' = 'lease';
        if (step === 'upload-rent-roll') context = 'property-doc';

        await processFiles(files, context);

        if (fileInputRef.current) fileInputRef.current.value = '';
    }, [step, processFiles]);


    const handleManualEntryStart = () => {
        const count = parseInt(manualUnitCount) || 1;
        const newUnits = Array.from({ length: count }).map((_, i) => ({
            unitNumber: `Unit ${i + 1}`,
            tenantName: 'Vacant', // Defaults
            status: 'Vacant' as const,
            currentRent: 0,
            bedrooms: 1,
            bathrooms: 1
        }));

        setRentRollData({
            units: newUnits,
            totals: {},
            confidence: {}
        });
        setStep('review');
    };

    const handleConfirmData = () => {

        // Transform rentRollData.units to WizardData.rentRollUnits
        const finalData: WizardData = {
            property: {
                address: propertyData.address,
                city: propertyData.city,
                state: propertyData.state,
                zipCode: propertyData.zipCode,
                units: rentRollData.units.length
            },
            rentRollUnits: rentRollData.units.map(u => ({
                unitNumber: u.unitNumber,
                tenantName: u.tenantName,
                currentRent: u.currentRent,
                marketRent: u.marketRent,
                leaseEndDate: u.leaseEndDate,
                leaseStartDate: u.leaseStartDate,
                status: u.status,
                email: u.email,
                phone: u.phone,
                deposit: u.deposit
            }))
        };

        onAnalysisComplete(finalData);
    };

    const renderOccupancyCheck = () => (
        <div className="space-y-6 text-center animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="mx-auto w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4">
                <Users className="w-8 h-8 text-blue-600" />
            </div>
            <h3 className="text-xl font-semibold">Is the property currently occupied?</h3>
            <p className="text-gray-500 max-w-sm mx-auto">
                We can help you set up your rent roll automatically if you have existing tenants.
            </p>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-lg mx-auto mt-8">
                <Card
                    className="p-6 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group border-2 border-transparent shadow-sm hover:shadow-md bg-white"
                    onClick={() => setStep('upload-lease')}
                >
                    <div className="space-y-4">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mx-auto group-hover:bg-blue-200 transition-colors">
                            <FileText className="w-5 h-5 text-blue-600" />
                        </div>
                        <div>
                            <h4 className="font-medium mb-1">Yes, I have leases</h4>
                            <p className="text-sm text-gray-500">Upload lease PDFs to auto-create rent roll</p>
                        </div>
                    </div>
                </Card>

                <Card
                    className="p-6 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group border-2 border-transparent shadow-sm hover:shadow-md bg-white"
                    onClick={() => setStep('manual-entry')}
                >
                    <div className="space-y-4">
                        <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mx-auto group-hover:bg-green-200 transition-colors">
                            <Check className="w-5 h-5 text-green-600" />
                        </div>
                        <div>
                            <h4 className="font-medium mb-1">Yes, but no files</h4>
                            <p className="text-sm text-gray-500">Manually enter tenant details</p>
                        </div>
                    </div>
                </Card>

                <Card
                    className="p-6 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group border-2 border-transparent shadow-sm hover:shadow-md bg-white col-span-1 md:col-span-2"
                    onClick={() => {
                        setManualUnitCount('1');
                        setStep('manual-entry');
                    }}
                >
                    <div className="flex items-center justify-between px-4">
                        <div className="flex items-center gap-4 text-left">
                            <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                                <Building className="w-5 h-5 text-gray-600" />
                            </div>
                            <div>
                                <h4 className="font-medium mb-1">No, it&apos;s vacant</h4>
                                <p className="text-sm text-gray-500">Start with empty units</p>
                            </div>
                        </div>
                        <ArrowRight className="w-5 h-5 text-gray-400 group-hover:text-blue-600" />
                    </div>
                </Card>
            </div>
            <div className="mt-6">
                <Button variant="ghost" size="sm" onClick={() => setStep('upload-rent-roll')} className="text-gray-400 hover:text-gray-600">
                    I have a rent roll file (Excel/CSV)
                </Button>
            </div>
        </div>
    );

    const renderUploadZone = (title: string, subtitle: string, context: 'lease' | 'rent-roll') => (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center space-y-2">
                <h3 className="text-lg font-semibold">{title}</h3>
                <p className="text-sm text-gray-500">{subtitle}</p>
            </div>

            <div
                className={cn(
                    "border-2 border-dashed rounded-xl p-10 text-center transition-all duration-200 ease-in-out cursor-pointer",
                    isDragging ? "border-blue-500 bg-blue-50 scale-[1.02]" : "border-gray-200 hover:border-blue-400 hover:bg-gray-50",
                    error ? "border-red-300 bg-red-50" : ""
                )}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
            >
                <input
                    type="file"
                    ref={fileInputRef}
                    className="hidden"
                    accept={context === 'lease' ? ".pdf,.doc,.docx" : ".xlsx,.xls,.csv,.pdf"}
                    multiple={true} // Allow multiple files
                    onChange={handleFileSelect}
                />

                <div className="flex flex-col items-center gap-4">
                    <div className={cn(
                        "p-4 rounded-full transition-colors",
                        isDragging ? "bg-blue-100" : "bg-gray-100"
                    )}>
                        {isAnalyzing ? (
                            <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
                        ) : (
                            <Upload className={cn(
                                "w-8 h-8",
                                isDragging ? "text-blue-600" : "text-gray-500"
                            )} />
                        )}
                    </div>

                    <div className="space-y-1">
                        {isAnalyzing ? (
                            <div className="space-y-2">
                                <h4 className="font-medium text-blue-700 text-lg">Analyzing Files...</h4>
                                {parsingProgress && (
                                    <div className="w-full max-w-xs mx-auto space-y-1">
                                        <Progress value={(parsingProgress.current / parsingProgress.total) * 100} className="h-2" />
                                        <p className="text-xs text-blue-600">
                                            Processing {parsingProgress.current} of {parsingProgress.total}: {parsingProgress.filename}
                                        </p>
                                    </div>
                                )}
                                <p className="text-sm text-blue-600/80">{analysisStep}</p>
                            </div>
                        ) : (
                            <>
                                <p className="font-medium text-gray-900">
                                    Click or drag files here
                                </p>
                                <p className="text-sm text-gray-500">
                                    {context === 'lease' ? 'Upload all your lease PDFs' : 'Excel, CSV, or PDF rent rolls'}
                                </p>
                            </>
                        )}
                    </div>
                </div>
            </div>

            {error && (
                <div className="flex items-center gap-2 text-sm text-red-600 bg-red-50 p-3 rounded-lg">
                    <AlertCircle className="w-4 h-4" />
                    <p>{error}</p>
                    <button onClick={() => setError(null)} className="ml-auto hover:text-red-800">
                        <X className="w-4 h-4" />
                    </button>
                </div>
            )}

            <Button
                variant="ghost"
                className="w-full text-gray-400 hover:text-gray-600"
                onClick={() => setStep('occupancy-check')}
            >
                Back
            </Button>
        </div>
    );

    const renderReview = () => (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="flex items-center justify-between">
                <div className="space-y-1">
                    <h3 className="text-lg font-semibold">Review Rent Roll</h3>
                    <p className="text-sm text-gray-500">
                        We found {rentRollData.units.length} units. Please verify the details.
                    </p>
                </div>
                <Button onClick={() => setStep('manual-entry')} variant="outline" size="sm">
                    <Plus className="w-4 h-4 mr-2" /> Add Unit
                </Button>
            </div>

            <Card className="overflow-hidden border text-sm">
                <div className="max-h-[400px] overflow-auto">
                    <Table>
                        <TableHeader className="bg-gray-50 sticky top-0 z-10">
                            <TableRow>
                                <TableHead>Unit</TableHead>
                                <TableHead>Tenant</TableHead>
                                <TableHead>Status</TableHead>
                                <TableHead className="text-right">Rent</TableHead>
                                <TableHead className="text-right">Deposit</TableHead>
                                <TableHead></TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {rentRollData.units.length === 0 ? (
                                <TableRow>
                                    <TableCell colSpan={6} className="text-center py-8 text-gray-500">
                                        No units found. Add one manually.
                                    </TableCell>
                                </TableRow>
                            ) : rentRollData.units.map((unit, idx) => (
                                <TableRow key={idx}>
                                    <TableCell className="font-medium">{unit.unitNumber}</TableCell>
                                    <TableCell>
                                        <div className="font-medium">{unit.tenantName}</div>
                                        <div className="text-xs text-gray-500 flex gap-2">
                                            {unit.email && <span>{unit.email}</span>}
                                            {unit.phone && <span>{unit.phone}</span>}
                                        </div>
                                    </TableCell>
                                    <TableCell>
                                        <div className={cn(
                                            "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium",
                                            unit.status === 'Occupied' ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-800"
                                        )}>
                                            {unit.status}
                                        </div>
                                    </TableCell>
                                    <TableCell className="text-right">
                                        {unit.currentRent ? `$${unit.currentRent}` : '-'}
                                    </TableCell>
                                    <TableCell className="text-right">
                                        {unit.deposit ? `$${unit.deposit}` : '-'}
                                    </TableCell>
                                    <TableCell>
                                        <Button
                                            variant="ghost"
                                            size="sm"
                                            className="h-8 w-8 p-0 text-gray-400 hover:text-red-600"
                                            onClick={() => {
                                                const newUnits = [...rentRollData.units];
                                                newUnits.splice(idx, 1);
                                                setRentRollData({
                                                    ...rentRollData,
                                                    units: newUnits,
                                                    totals: rentRollData.totals || {},
                                                    confidence: rentRollData.confidence || {}
                                                });
                                            }}
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </Button>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </div>
            </Card>

            <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                    <Label>Property Address</Label>
                    <Input
                        value={propertyData.address}
                        onChange={(e) => setPropertyData({ ...propertyData, address: e.target.value })}
                        placeholder="123 Main St"
                    />
                </div>
                <div className="grid grid-cols-3 gap-2">
                    <div className="space-y-2 col-span-2">
                        <Label>City</Label>
                        <Input
                            value={propertyData.city}
                            onChange={(e) => setPropertyData({ ...propertyData, city: e.target.value })}
                            placeholder="City"
                        />
                    </div>
                    <div className="space-y-2">
                        <Label>State</Label>
                        <Input
                            value={propertyData.state}
                            onChange={(e) => setPropertyData({ ...propertyData, state: e.target.value })}
                            placeholder="State"
                        />
                    </div>
                </div>
            </div>

            <div className="flex gap-3 pt-4">
                <Button
                    variant="outline"
                    className="flex-1"
                    onClick={() => setStep('occupancy-check')}
                >
                    Back
                </Button>
                <Button
                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white"
                    onClick={handleConfirmData}
                >
                    Confirm & Create Property
                </Button>
            </div>
        </div>
    );

    const renderManualEntry = () => (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center space-y-2 mb-6">
                <h3 className="text-lg font-semibold">How many units?</h3>
                <p className="text-sm text-gray-500">We&apos;ll create a template for you to fill in.</p>
            </div>

            <div className="max-w-xs mx-auto space-y-4">
                <div className="space-y-2">
                    <Label>Number of Units</Label>
                    <Input
                        type="number"
                        min="1"
                        placeholder="e.g. 4"
                        value={manualUnitCount}
                        onChange={(e) => setManualUnitCount(e.target.value)}
                        className="text-center text-lg"
                    />
                </div>

                <div className="grid grid-cols-2 gap-3 pt-4">
                    <Button
                        variant="ghost"
                        onClick={() => setStep('occupancy-check')}
                    >
                        Back
                    </Button>
                    <Button
                        onClick={handleManualEntryStart}
                        disabled={!manualUnitCount || parseInt(manualUnitCount) < 1}
                    >
                        Continue
                    </Button>
                </div>
            </div>
        </div>
    );

    return (
        <Card className={cn("bg-white shadow-lg border-none", className)}>
            <div className="p-1">
                {step === 'occupancy-check' && renderOccupancyCheck()}

                {step === 'upload-lease' && renderUploadZone(
                    'Upload Lease Agreements',
                    'Upload one or more PDF leases. We\'ll extract the details into a rent roll.',
                    'lease'
                )}

                {step === 'upload-rent-roll' && renderUploadZone(
                    'Upload Rent Roll',
                    'Upload your existing rent roll (Excel, CSV, PDF).',
                    'rent-roll'
                )}

                {step === 'review' && renderReview()}

                {step === 'manual-entry' && renderManualEntry()}
            </div>
        </Card>
    );
}
